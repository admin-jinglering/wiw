/*! wiw 2016-12-07 */
function SettingsCtrl(a,b,c,d,e){var f=angular.copy(a.user.settings);b.user=d,b.Manager=[{name:"Border Style",stage:"new",setting:"border-style",items:["dotted","dashed","solid","double","groove","ridge","inset","outset"]},{name:"Border Width",stage:"new",setting:"border-width",items:[".5px","1px","2px","3px","4px","5px","6px","7px","8px","9px","10px"]},{name:"Border Style",stage:"unpub",setting:"border-style",items:["dotted","dashed","solid","double","groove","ridge","inset","outset"]},{name:"Border Width",stage:"unpub",setting:"border-width",items:[".5px","1px","2px","3px","4px","5px","6px","7px","8px","9px","10px"]},{name:"Border Style",stage:"pub",setting:"border-style",items:["dotted","dashed","solid","double","groove","ridge","inset","outset"]},{name:"Border Width",stage:"pub",setting:"border-width",items:[".5px","1px","2px","3px","4px","5px","6px","7px","8px","9px","10px"]}],b.apply=function(){e.user_settings.save({user:a.user},function(a){}),c.hide()},b.cancel=function(){a.user.settings=f,c.hide()}}function DialogController(a,b,c,d,e){a.shift=c,a.user=d,a.creator=e,a.shift.start_time=new Date(c.start_time),a.shift.end_time=new Date(c.end_time),a.formatAvatar=function(a){return sprintf(a,"sm")},a.hide=function(){b.hide()},a.cancel=function(){b.cancel()},a.answer=function(a){b.hide(a)}}function DialogController(a,b,c,d,e){a.shift=c,a.user=d,a.creator=e,a.shift.start_time=new Date(c.start_time),a.shift.end_time=new Date(c.end_time),a.formatAvatar=function(a){return sprintf(a,"sm")},a.hide=function(){b.hide()},a.cancel=function(){b.cancel()},a.answer=function(a){b.hide(a)}}var wiwApp=angular.module("WIW",["ngMaterial","ngMessages","ngAnimate","ngSanitize","ngResource","ngCookies","ui.router","ui.bootstrap","ui.bootstrap.contextMenu","sprintf","ngMdIcons","ui.grid","ui.grid.resizeColumns","ui.grid.edit","ui.grid.selection","ui.grid.cellNav"]).run(["$rootScope","$state","$stateParams",function(a,b,c){a.$state=b,a.$stateParams=c,a.site_title="When I Work SpreadSheets"}]).config(["$stateProvider","$urlRouterProvider","$mdThemingProvider",function(a,b,c){b.otherwise("/"),a.state("login",{url:"/",controller:"AuthCtrl",templateUrl:"html/auth/login.html"}).state("schedule",{url:"/schedule",views:{"":{templateUrl:"html/sched/schedule.html",controller:"SchedCtrl"},"shifts@schedule":{templateUrl:"html/sched/accord.html"}}}).state("grid",{abstract:!0,url:"/grid",views:{"":{templateUrl:"html/sched/schedule.html",controller:"GridCtrl"},"shifts@grid":{templateUrl:"html/sched/grid.html"}}}).state("grid.site",{url:"/:site"}).state("logout",{url:"/logout",template:'<h2 ng-init="logout()">Logout</h2>',controller:"AuthCtrl"}),c.theme("login").primaryPalette("green").warnPalette("red").backgroundPalette("grey"),c.theme("default").primaryPalette("green").accentPalette("light-green").warnPalette("red").backgroundPalette("blue-grey"),c.theme("dates").primaryPalette("grey").backgroundPalette("grey")}]),wiwDevKey="580dfbc2e8a2b604ad6cac26e9500c1bd22c7ec9";wiwApp.factory("AuthFactory",["$resource",function(a){var b;return $.getJSON("/js/var/wiw.json",function(a){b=a.WKey}),{wiwLogin:a("https://api.wheniwork.com/2/login",null,{login:{method:"POST",headers:{"Content-Type":"application/json","W-Key":b}}}),authSesh:a("/login",null,{authed:{method:"POST",headers:{}}})}}]),wiwApp.controller("AuthCtrl",["$scope","$cookies","$state","$rootScope","AuthFactory",function(a,b,c,d,e){a.showLogin=!1,a.login=function(){var f=e.wiwLogin;f.login({username:a.User.email,password:a.User.pass},function(f){a.User.pass=f.login.token,console.log("Auth from WIW success"),b.put("uid",f.user.id),b.put("tok",f.login.token),d.user=f,e.authSesh.authed({uid:f.user.id,tok:f.login.token},function(a){c.go("schedule")})},function(b){b&&(a.error=b.data.error)}),setTimeout(function(){a.error="No response from server!"},45e3)},a.logout=function(){b.remove("uid"),b.remove("tok"),c.go("login")},b.get("uid")&&b.get("tok")?(d.user={},d.user.user={},d.user.user.id=b.get("uid"),d.user.login={},d.user.login.token=b.get("tok"),e.authSesh.authed({uid:d.user.user.id,tok:d.user.login.token},function(a){c.go("schedule")},function(b){console.log(b),a.showLogin=!0})):a.showLogin=!0}]),wiwApp.factory("SchedFactory",["$resource","$rootScope",function(a,b){return{users:a("https://api.wheniwork.com/2/users",{location_id:"@location_id"},null),user:a("https://api.wheniwork.com/2/users/:id",{id:"@id"},null),shifts:a("https://api.wheniwork.com/2/shifts",{location_id:"@location_id",user_id:"@user_id"},{create:{method:"POST",params:{color:"@color",created_at:"@created_at",creator_id:"@creator_id",end_time:"@end_time",location_id:"@location_id",notes:"@notes",position_id:"@position_id",published:"@published",published_date:"@published_date",start_time:"@start_time",user_id:"@user_id"},headers:{"Content-Type":"application/json","W-Token":"@W-Token"}}}),locations:a("https://api.wheniwork.com/2/locations",null,null),positions:a("https://api.wheniwork.com/2/positions",null,null),blocks:a("https://api.wheniwork.com/2/blocks",null,null),user_settings:a("/users",null,{put:{method:"PUT"}}),new_shifts:a("/shifts/:user_id/:date",{user_id:"@user_id",date:"@date"},{put:{method:"PUT"}})}}]),wiwApp.controller("SchedCtrl",["SchedFactory","AuthFactory","$rootScope","$scope","$cookies","$state","$mdDialog","$mdMedia","$filter",function(a,b,c,d,e,f,g,h,i){function j(a){return d.showUnpub||a}function k(a,b){var c=(h("sm")||h("xs"))&&d.customFullscreen;g.show({controller:DialogController,templateUrl:"html/sched/shInfo.html",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:c,locals:{shift:b,user:d.Schedule.users[t[b.user_id]],creator:d.Schedule.users[t[b.creator_id]]}}).then(function(a){d.status='You said the information was "'+a+'".'},function(){d.status="You cancelled the dialog."}),d.$watch(function(){return h("xs")||h("sm")},function(a){d.customFullscreen=a===!0})}function l(a){if(a)var b=parseInt(a.substring(0,2),16),c=parseInt(a.substring(2,4),16),d=parseInt(a.substring(4,6),16);var e={background:"rgba("+b+","+c+","+d+",.7)",background:"radial-gradient(rgba(220,220,220,1),rgba("+b+","+c+","+d+",1))",background:"-webkit-radial-gradient(rgba(220,220,220,1),rgba("+b+","+c+","+d+",1))"},f={background:"rgba(196,224,71,.7)",background:"radial-gradient(rgba(196,224,71,.5),rgba(196,224,71,.8))",background:"-webkit-radial-gradient(rgba(196,224,71,.5),rgba(196,224,71,.8))"};return a?e:f}var m,n,o,p="EEE, dd MMM yyyy HH:mm:ss Z",q="M/d/yy",r=10,s=5,t={},u={},v=new Date,w=new Date(v.getFullYear(),v.getMonth(),v.getDate(),5,0,0),x=new Date(v.getFullYear(),v.getMonth(),v.getDate()+7*s,23,59,58);d.site_title=c.site_title,d.loading=!0,d.showUnpub=!1,d.Schedule={},d.Schedule.newShifts={},d.Schedule.newShifts.days=[],d.Schedule.newShifts.shifts=[],d.Schedule.newShifts.removed=[],d.Schedule.users=[],d.Schedule.start=w,d.Schedule.end=x,d.closeOthers=!1,d.isOpen=!0,d.showInfo=k,d.getGrad=l;var y=function(){for(var a in d.Schedule.users)d.Schedule.users[a].numShifts=0;for(var b in d.Schedule.weeks)for(var c in d.Schedule.weeks[b].days){d.Schedule.weeks[b].days[c].Day=0,d.Schedule.weeks[b].days[c].Afternoon=0;for(var e in d.Schedule.weeks[b].days[c].shifts)if(d.Schedule.weeks[b].days[c].shifts[e].id||d.Schedule.weeks[b].days[c].shifts[e].selected_pos){var f;j(d.Schedule.weeks[b].days[c].shifts[e].published)&&d.Schedule.users[t[d.Schedule.weeks[b].days[c].shifts[e].user_id]].numShifts++,f=new Date(d.Schedule.weeks[b].days[c].shifts[e].start_time),"TRAVEL"!==d.Schedule.weeks[b].days[c].shifts[e].position.name&&j(d.Schedule.weeks[b].days[c].shifts[e].published)&&(f.getHours()<r?d.Schedule.weeks[b].days[c].Day++:d.Schedule.weeks[b].days[c].Afternoon++)}}};d.changeLoc=function(a){c.user.location!==a&&(c.user.location=a,A(function(){C(E)}))},d.changePub=function(){d.showUnpub=!d.showUnpub,y()},d.dateChange=function(){A(function(){C(E)})},d.formatAvatar=function(a){return sprintf(a,"sm")},d.showPubUnpub=j,d.getUserByID=function(a){for(var b in d.Schedule.users)if(d.Schedule.users[b].id===a)return d.Schedule.users[b].first_name+" "+d.Schedule.users[b].last_name},d.getSettings=function(a,b){if(c.user.settings)var d=Object.getOwnPropertyNames(c.user.settings);else var d=[];var e={};a.selected_pos?e["border-color"]="#"+a.selected_pos.color:e["border-color"]="#ccc";for(var f in d){var g=d[f].split("-");g[0]===b&&(e[g[1]+"-"+g[2]]=c.user.settings[d[f]])}return e},d.showSettings=function(b){var e=(h("sm")||h("xs"))&&d.customFullscreen;g.show({controller:SettingsCtrl,templateUrl:"html/user/settings.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!1,fullscreen:e,locals:{user:c.user,SchedFactory:a}}).then(function(a){d.status='You said the information was "'+a+'".'},function(){d.status="You cancelled the dialog."}),d.$watch(function(){return h("xs")||h("sm")},function(a){d.customFullscreen=a===!0})},d.getDate=function(a,b){return new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate(),a.split(":")[0],a.split(":")[1],a.split(":")[2])},d.createShifts=function(){for(var b in d.Schedule.newShifts.shifts){var c=d.Schedule.newShifts.shifts[b];c&&a.new_shifts.save({shift:c},function(a){console.log(a)})}for(var b in d.Schedule.newShifts.removed){var e=d.Schedule.newShifts.removed[b];e&&a.new_shifts.remove({user_id:parseInt(e.user_id),date:e.date},function(a){console.log(a),delete d.Schedule.newShifts.removed[b]})}};var z=function(a,b,e,f,g){var h={},j=new Date(b);if(a.selected_pos)if(a.selected_pos.removed){if(d.Schedule.newShifts.days[j.toDateString()]&&d.Schedule.newShifts.days[j.toDateString()][a.user_id]){delete d.Schedule.newShifts.days[j.toDateString()][a.user_id],delete a.selected_pos;var k=a.user_id,l=a.position;delete d.Schedule.weeks[g].days[f].shifts[e],d.Schedule.weeks[g].days[f].shifts[e]={},d.Schedule.weeks[g].days[f].shifts[e].user_id=k,d.Schedule.weeks[g].days[f].shifts[e].position=l,d.Schedule.newShifts.removed[parseInt(g+""+f+e)]=angular.copy(d.Schedule.newShifts.shifts[parseInt(g+""+f+e)]),delete d.Schedule.newShifts.shifts[parseInt(g+""+f+e)];var m=0;for(var n in d.Schedule.newShifts.shifts){var a=d.Schedule.newShifts.shifts[n];a&&m++}m||(delete d.Schedule.newShifts.shifts,d.Schedule.newShifts.shifts=[]),y()}}else{var o=new Date,r=a.selected_pos.block.start_time.split(":"),s=a.selected_pos.block.end_time.split(":"),t=new Date(j.getFullYear(),j.getMonth(),j.getDate(),s[0],s[1],s[2]),u=new Date(j.getFullYear(),j.getMonth(),j.getDate(),r[0],r[1],r[2]);h.color=a.selected_pos.color,h.created_at=i("date")(o,p),h.date=i("date")(u,q),h.end_time=i("date")(t,p),h.location_id=c.user.location,h.notes=a.selected_pos.block.notes,h.position_id=a.selected_pos.id,h.published=!1,h.published_date=null,h.start_time=i("date")(u,p),h.user_id=a.user_id,d.Schedule.newShifts.days[j.toDateString()]||(d.Schedule.newShifts.days[j.toDateString()]={}),d.Schedule.newShifts.days[j.toDateString()][a.user_id]=h;var v=a.selected_pos;d.Schedule.weeks[g].days[f].shifts[e]=h,d.Schedule.weeks[g].days[f].shifts[e].selected_pos=v,d.Schedule.weeks[g].days[f].shifts[e].position={},d.Schedule.weeks[g].days[f].shifts[e].position.name="",d.Schedule.newShifts.shifts[parseInt(g+""+f+e)]=h,delete d.Schedule.newShifts.removed[parseInt(g+""+f+e)],y()}};d.addShift=z;var A=function(a){d.Schedule.weeks&&(d.Schedule.weeks=[]),d.Schedule.weeks=[],d.loading=!0;var b=new Date(d.Schedule.start);w=new Date(b.getFullYear(),b.getMonth(),b.getDate(),5,0,0),x=new Date(d.Schedule.end.getFullYear(),d.Schedule.end.getMonth(),d.Schedule.end.getDate(),23,59,58);var c=0,e=w,f=new Date(b.getFullYear(),b.getMonth(),b.getDate()+c,23,59,58);d.Schedule.start=w,d.Schedule.end=x,d.Schedule.weeks[0]={},d.Schedule.weeks[0].start=w;for(var g=0;e<=x;g++){if(d.Schedule.weeks[g]={},d.Schedule.weeks[g].days=[],0===g)var h=7-b.getDay();else var h=7;for(var i=0;i<h&&(d.Schedule.weeks[g].days[i]={},d.Schedule.weeks[g].days[i].shifts=[],d.Schedule.weeks[g].days[i].Day=0,d.Schedule.weeks[g].days[i].Afternoon=0,e=new Date(b.getFullYear(),b.getMonth(),b.getDate()+c,5,0,0),f=new Date(b.getFullYear(),b.getMonth(),b.getDate()+c,23,59,58),d.Schedule.weeks[g].days[i].start=e,d.Schedule.weeks[g].days[i].end=f,0===i&&(d.Schedule.weeks[g].start=e),c++,!(f>=x));i++);if(d.Schedule.weeks[g].end=f,f>=x)break}"function"==typeof a&&a()},B=function(e){c.user=a.user.get({id:n,"W-Token":m},function(d){c.user=d.user,c.user.location=d.locations[0].id,b.authSesh.authed({uid:n,tok:m},function(b){a.user_settings.get(null,function(a){a.settings?c.user.settings=a.settings:c.user.settings={}}),a.new_shifts.get(null,function(a){var b=a.shifts;o=b})}),e(E),a.locations.get({"W-Token":m},function(a){c.user.locations=a.locations},function(a){console.log(a),f.go("login")})},function(a){console.log(a),f.go("login")}),a.positions.get({show_deleted:!0,"W-Token":m},function(b){d.Schedule.positions=b.positions;for(var c in b.positions)u[parseInt(b.positions[c].id)]=b.positions[c];a.blocks.get({"W-Token":m},function(a){d.Schedule.blocks=a.blocks;for(var c in b.positions)for(var e in a.blocks)if(a.blocks[e].position_id===b.positions[c].id){d.Schedule.positions[c].block=a.blocks[e],u[parseInt(b.positions[c].id)].block=a.blocks[e];break}},function(a){console.log(a),f.go("login")})},function(a){console.log(a),f.go("login")})},C=function(b){a.users.get({"W-Token":m,location_id:c.user.location},function(a){d.Schedule.users=[];var c;for(var e in a.users)3868711===a.users[e].id?(delete a.users[e],c=e):e>c?(t[a.users[e].id]=e-1,d.Schedule.users[e-1]=a.users[e],d.Schedule.users[e-1].numShifts=0,b(e-1,d.Schedule.users[e-1].id)):(t[a.users[e].id]=e,d.Schedule.users[e]=a.users[e],d.Schedule.users[e].numShifts=0,b(e,d.Schedule.users[e].id));F()},function(a){console.log(a),f.go("login")})},D=function(a,b){for(var c in o)b.push(o[c]);for(var e in d.Schedule.weeks)for(var f in d.Schedule.weeks[e].days){0===b.length&&(d.Schedule.weeks[e].days[f].shifts[a]={},d.Schedule.weeks[e].days[f].shifts[a].user_id=d.Schedule.users[a].id,d.Schedule.weeks[e].days[f].shifts[a].position={},d.Schedule.weeks[e].days[f].shifts[a].position.name="");for(var g in b){var h=b[g],i=d.Schedule.weeks[e].days[f].start.toDateString(),k=new Date(h.start_time).toDateString();if(i===k&&a===t[h.user_id]){var l=new Date(h.start_time);d.Schedule.weeks[e].days[f].shifts[a]=angular.copy(h),d.Schedule.weeks[e].days[f].shifts[a].start_time=new Date(h.start_time),d.Schedule.weeks[e].days[f].shifts[a].end_time=new Date(h.end_time),d.Schedule.weeks[e].days[f].shifts[a].published&&(d.Schedule.weeks[e].days[f].shifts[a].published_date=new Date(h.published_date)),d.Schedule.weeks[e].days[f].shifts[a].acknowledged&&(d.Schedule.weeks[e].days[f].shifts[a].acknowledged_at=new Date(h.acknowledged_at)),h.selected_pos?z(d.Schedule.weeks[e].days[f].shifts[a],i,a,f,e):d.Schedule.weeks[e].days[f].shifts[a].position=u[h.position_id],j(d.Schedule.weeks[e].days[f].shifts[a].published)&&d.Schedule.users[a].numShifts++,"TRAVEL"!==d.Schedule.weeks[e].days[f].shifts[a].position.name&&j(d.Schedule.weeks[e].days[f].shifts[a].published)&&(l.getHours()<r?d.Schedule.weeks[e].days[f].Day++:d.Schedule.weeks[e].days[f].Afternoon++),b.splice(g,1);break}i===k&&0!==b.length||(d.Schedule.weeks[e].days[f].shifts[a]={},d.Schedule.weeks[e].days[f].shifts[a].user_id=h.user_id,d.Schedule.weeks[e].days[f].shifts[a].position={},d.Schedule.weeks[e].days[f].shifts[a].position.name="")}}a===d.Schedule.users.length-1&&F()},E=function(b,c){a.shifts.get({start:d.Schedule.start,end:d.Schedule.end,user_id:c,unpublished:!0,"W-Token":m},function(a){D(b,a.shifts)})},F=function(){setTimeout(function(){c.user.role<3&&(d.showUnpub=!0),d.loading=!1,d.$apply()},500)};e.get("uid")&&e.get("tok")?(c.user||(c.user={},c.user.user={},c.user.login={},c.user.user.id=e.get("uid"),c.user.login.token=e.get("tok")),m=e.get("tok"),n=e.get("uid"),A(function(){B(C)})):f.go("login"),setTimeout(function(){console.log(d)},1e3)}]),wiwApp.controller("GridCtrl",["SchedFactory","AuthFactory","$rootScope","$scope","$cookies","$state","$mdDialog","$mdMedia","$filter","uiGridConstants",function(a,b,c,d,e,f,g,h,i,j){var k={init:function(c,e,f){this.user_id=parseInt(c),this.token=e,this.locations=[],this.user={},this.xpos=[],this.xloc=[],this.positions=[];var g=this,h=this.user_id,i=this.token,j=function(c){var d={};a.user.get({id:h,"W-Token":i},function(e){d=e.user,b.authSesh.authed({uid:h,tok:i},function(b){a.user_settings.get(null,function(a){a.settings?d.settings=a.settings:d.settings={},c(d)},function(a){console.log(a),c(a)})},function(a){console.log(a),c(a)})})},k=function(b){var c=g.token,d=g.xloc=[];a.locations.get({"W-Token":c},function(a){b(a.locations);for(var c in a.locations)d[a.locations[c].id]=a.locations[c]},function(a){console.log(a),b(a)})},l=function(b){var c=g.positions,d=g.token,e=g.xpos=[];a.positions.get({show_deleted:!0,"W-Token":d},function(f){c=f.positions;for(var g in c)e[parseInt(f.positions[g].id)]=c[g];a.blocks.get({"W-Token":d},function(a){for(var d in c){c[d].blocks=[];for(var f in a.blocks)a.blocks[f].position_id===c[d].id&&(c[d].blocks.push(a.blocks[f]),e[parseInt(c[d].id)].blocks.push(a.blocks[f]))}b(c)},function(a){console.log(a),b(a)})},function(a){console.log(a),b(a)})};j(function(a){g.user=a,k(function(a){g.locations=a,l(function(a){g.positions=a,f();var b=[],c="";for(var e in a)if(a[e].blocks.length)for(var h in a[e].blocks)if(a[e].blocks[h].color){var i=a[e].blocks[h].color;if(!b[i.toString()]){b[i.toString()]=i;var j=parseInt(i.substring(0,2),16),k=parseInt(i.substring(2,4),16),h=parseInt(i.substring(4,6),16);c=c+"\n.shift"+i+"{\n background: rgba("+j+","+k+","+h+",.7) !important;\nbackground: radial-gradient(rgba(220,220,220,1),rgba("+j+","+k+","+h+",1)) !important;\nbackground: -webkit-radial-gradient(rgba(220,220,220,1),rgba("+j+","+k+","+h+",1)) !important;\n}\n"}}d.style=c})})})}},l=function(b,c,e){var f=this,j="EEE, dd MMM yyyy HH:mm:ss Z",k=c.token,l=(f.users,f.xusers,new Date),m=5,n=new Date(l.getFullYear(),l.getMonth(),l.getDate(),5,0,0),o=new Date(l.getFullYear(),l.getMonth(),l.getDate()+7*m,23,59,58);this.gridOptions={columnDefs:[],data:[],enableRowHeaderSelection:!1,enableSortings:!1,enableFiltering:!0,enableCellEdit:!1,enableGridMenu:!0,enableRowSelection:!1,enableSelectAll:!0,minRowsToShow:15,modifierKeysToMultiSelectCells:!0,multiSelect:!0,showGridFooter:!1,showColumnFooter:!0,onRegisterApi:function(a){d.gridApi=a;d.gridApi.core.addRowHeaderColumn({name:"date",field:"date","min-width":"4%",width:"4%","max-width":"40px",type:"date",cellFilter:'date:"MM/dd"',footerCellTemplate:function(){return'<div class="ui-grid-footer-panel ui-grid-footer-aggregates-row"><!-- tfooter --><div class="ui-grid-footer ui-grid-footer-viewport"><div class="ui-grid-footer-canvas center"><div class="ui-grid-footer-cell-wrapper" ng-style="colContainer.headerCellWrapperStyle()"><div role="row" class="center ui-grid-footer-cell-row"><div ui-grid-footer-cell role="gridcell" style="text-align:center" ng-repeat="col in colContainer.renderedColumns track by col.uid" col="col" render-index="$index" class="ui-grid-footer-cell ui-grid-clearfix center">DATE</div></div></div></div></div></div>'}})}},e?this.callbk=e:this.callbk=function(){},this.location=c.xloc[b],this.location_id=b,this.xusers=[],this.users=[],this.start=n,this.end=o,this.copyPaste={};var p=function(b){var c=f.location_id;a.users.get({"W-Token":k,location_id:c},function(a){b(a.users)},function(a){console.log(a),b(a)})},q=function(b,c,d,e){a.shifts.get({start:b,end:c,unpublished:!0,"W-Token":k,location_id:f.location_id},function(a){e(a,b,d)})};this.refresh=function(a){for(var b=0,d=f.start;d.getTime()<f.end.getTime();d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1,5,0,0),b++){var e=new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,58);q(i("date")(d,j),i("date")(e,j),b,function(a,b,d){var e={date:new Date(b)};e.days=0,e.afternoons=0;for(var g in a.shifts){var h=a.shifts[g],i=f.users[f.xusers[h.user_id]];if(i){var b=new Date(h.start_time);i.numShifts++,h.user=i,h.start_time=new Date(h.start_time),h.end_time=new Date(h.end_time),h.created_at=new Date(h.created_at),h.published&&(h.published_date=new Date(h.published_date)),h.acknowledged&&(h.acknowledged_at=new Date(h.acknowledged_at)),h.position=c.xpos[h.position_id],e[i.first_name+""+i.last_name]=h,h.position.name&&"TRAVEL"!==h.position.name&&(b.getHours()<10?e.days++:e.afternoons++)}}f.gridOptions.data[d]=e,d===Math.floor((f.end.getTime()-f.start.getTime())/864e5)})}setTimeout(function(){a&&a()},1e3)},this.dateChange=function(a){var c=d.Schedule.start,e=d.Schedule.end;f.start=new Date(c.getFullYear(),c.getMonth(),c.getDate(),5,0,0),f.end=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,58),f.refresh(function(){a(f,b)})},this.func={},this.func.showInfo=function(a,b,c,e){if(!a.ctrlKey){var i=c.entity[e.name],j=(h("sm")||h("xs"))&&d.customFullscreen;g.show({controller:DialogController,templateUrl:"html/sched/shInfo.html",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:j,locals:{shift:i,user:d.site.users[f.xusers[i.user_id]],creator:d.site.users[f.xusers[i.creator_id]]}}).then(function(a){d.status='You said the information was "'+a+'".'},function(){d.status="You cancelled the dialog."}),d.$watch(function(){return h("xs")||h("sm")},function(a){d.customFullscreen=a===!0})}},p(function(a){function c(a){for(var b in a)if(a[b].entity[this.name])return a[b].entity[this.name].user.numShifts}for(var d=0;d<a.length;d++)3868711!==a[d].id?(this.name=a[d].first_name+""+a[d].last_name,f.xusers[parseInt(a[d].id)]=parseInt(d),a[d].numShifts=0,f.gridOptions.columnDefs.push({name:a[d].first_name+""+a[d].last_name,field:a[d].first_name+""+a[d].last_name+".position.name",aggregationType:c,enableSorting:!1,enableCellEdit:!0,aggregationHideLabel:!1,cellTemplate:function(){return'<div class="ui-grid-cell-contents" ng-class="grid.appScope.selectedStyle(grid,row,col)">\n\t\t\t\t\t\t\t\t\t<div ng-cloak class="shift-name text-center shift-mu" title ="Click for more info." ng-click="grid.appScope.site.func.showInfo($event,grid,row,col)" ng-mousedown="grid.appScope.buttEff($event)" ng-mouseleave="grid.appScope.buttEff($event)" ng-mouseup="grid.appScope.buttEff($event)" ng-bind="COL_FIELD CUSTOM_FILTERS" ng-class="\'shift\'+row.entity[col.name].color">\n\t\t\t\t\t\t\t\t\t</div></div>'}})):(a.splice(d,1),d--);f.gridOptions.columnDefs.push({name:"days",field:"days",width:"4%",allowCellFocus:!1,enableSorting:!1,enableCellEdit:!1},{name:"afternoons",field:"afternoons",width:"6%",allowCellFocus:!1,enableSorting:!1,enableCellEdit:!1}),f.gridOptions.rowTemplate="<div ng-repeat=\"(colRenderIndex, col) in colContainer.renderedColumns track by col.uid\" ui-grid-one-bind-id-grid=\"rowRenderIndex + '-' + col.uid + '-cell'\" class=\"ui-grid-cell\" ng-class=\"{ 'ui-grid-row-header-cell': col.isRowHeader,'weekend':row.entity['date'].getDay() === 0 || row.entity['date'].getDay() === 6}\" role=\"{{col.isRowHeader ? 'rowheader' : 'gridcell'}}\" ui-grid-cell></div>",f.users=a,f.refresh(function(){f.callbk(f,b)})})},m={formatAvatar:function(a){return sprintf(a,"sm")},captureCopy:function(a){var b,c=a.getCurrentSelection();return angular.forEach(c,function(a,c){var d=a.col.uid.split("-")[1];b?b&&d<b.col.uid.split("-")[1]?b=a:b&&d===b.col.uid.split("-")[1]&&a.row.entity.date<b.row.entity.date&&(b=a):b=a}),[c,b]},pasteShifts:function(a,b,c){var e,f=a.cellNav.getFocusedCell(),g=f.col.displayName.split(" ")[0],h=f.col.displayName.split(" ")[1];for(var i in d.site.users){var j=d.site.users[i];j.first_name===g&&j.last_name===h&&(f.uIndex=i)}for(var k in b){var l=b[k];l.offCol=parseInt(l.col.uid.split("-")[1],36)-parseInt(c.col.uid.split("-")[1],36),l.offRow=Math.floor((l.row.entity.date.getTime()-c.row.entity.date.getTime())/864e5);for(var m in d.gridOptions.data){var n=d.gridOptions.data[m];if(new Date(n.date.getFullYear(),n.date.getMonth(),n.date.getDate()).toDateString()===new Date(f.row.entity.date.getFullYear(),f.row.entity.date.getMonth(),f.row.entity.date.getDate()+l.offRow).toDateString()){var o=d.site.users[parseInt(f.uIndex)+l.offCol];if(l.newDate=n.date,n[o.first_name+o.last_name]?(l.occupied=!0,e=!0):l.occupied=!1,l.row.entity[l.col.name]){l[o.first_name+o.last_name]={};var p=l[o.first_name+o.last_name],q=l.row.entity[l.col.name];p.position=q.position,p.end_time=new Date(l.newDate.getFullYear(),l.newDate.getMonth(),l.newDate.getDate(),q.end_time.getHours(),q.end_time.getMinutes(),q.end_time.getSeconds()),p.start_time=new Date(l.newDate.getFullYear(),l.newDate.getMonth(),l.newDate.getDate(),q.start_time.getHours(),q.start_time.getMinutes(),q.start_time.getSeconds()),p.user=o,p.user_id=o.id,p.position_id=p.position.id,p.location_id=d.site.location_id,p.creator_id=d.wiw.user_id,p.account_id=q.account_id,p.created_at=new Date}}}}if(e&&confirm("You are going to be overwriting a shift. Is that okay?"))for(var k in b){var l=b[k];for(var m in d.gridOptions.data){var n=d.gridOptions.data[m];if(new Date(n.date.getFullYear(),n.date.getMonth(),n.date.getDate()).toDateString()===new Date(f.row.entity.date.getFullYear(),f.row.entity.date.getMonth(),f.row.entity.date.getDate()+l.offRow).toDateString()){var o=d.site.users[parseInt(f.uIndex)+l.offCol];l[o.first_name+o.last_name]?n[o.first_name+o.last_name]=l[o.first_name+o.last_name]:delete n[o.first_name+o.last_name]}}}else if(!e)for(var k in b){var l=b[k];for(var m in d.gridOptions.data){var n=d.gridOptions.data[m];if(new Date(n.date.getFullYear(),n.date.getMonth(),n.date.getDate()).toDateString()===new Date(f.row.entity.date.getFullYear(),f.row.entity.date.getMonth(),f.row.entity.date.getDate()+l.offRow).toDateString()){var o=d.site.users[parseInt(f.uIndex)+l.offCol];l[o.first_name+o.last_name]?n[o.first_name+o.last_name]=l[o.first_name+o.last_name]:delete n[o.first_name+o.last_name]}}}console.log(b),console.log(c)}};if(d.selectedStyle=function(a,b,c){for(var e in d.site.copyPaste.selection){var f=d.site.copyPaste.selection[e];if(f.col.name===c.name&&f.row.entity.date===b.entity.date)return"selected-cell"}return""},d.dateChange=function(){d.site.dateChange(function(a,b){d.gridOptions=d.site.gridOptions})},d.buttEff=function(a){var b={top:"-1px",left:"-1px","box-shadow":"3px 3px 3px gray"},c={top:"1px",left:"1px","box-shadow":"1px 1px 2px gray"};"mousedown"===a.type?$(a.target).animate(c,80):"mouseup"===a.type?$(a.target).animate(b,80):"mouseleave"===a.type&&$(a.target).animate(b,80)},d.showPubUnpub=function(a,b){var c=a.entity[b.name].published;return d.showUnpub||c},d.menuOptions=function(a){return this.nav=a.cellNav,[["Copy",function(){var a=m.captureCopy(this.nav),b=a[0],c=a[1];d.site.copyPaste.selection=b,d.site.copyPaste.nwSelCell=c,setTimeout(function(){d.$apply()},1500)}],["Paste",function(){m.pasteShifts(a,d.site.copyPaste.selection,d.site.copyPaste.nwSelCell)},function(){return!!d.site.copyPaste.selection}],null,["Remove",function(a){d.items.splice(a.$index,1)}]]},d.changeLoc=function(a){for(var b in n)n[b].location_id===a&&(d.site=n[b],d.gridOptions=n[b].gridOptions,d.gridOptions.columnDefs=n[b].gridOptions.columnDefs,d.loading=!1)},e.get("uid")&&e.get("tok")){var n=[];d.formatAvatar=m.formatAvatar,d.captureCopy=m.captureCopy,d.loading=!0;var o=d.wiw=new k.init(e.get("uid"),e.get("tok"),function(){c.user=o.user,c.user.locations=o.locations;for(var a in c.user.locations)n[a]=new l(o.locations[a].id,o,function(a,b){f.params.site===a.location.name&&(d.site=a,d.gridOptions=jQuery.extend(!0,{},d.site.gridOptions),d.Schedule={},d.Schedule.start=d.site.start,d.Schedule.end=d.site.end,setTimeout(function(){d.loading=!1,d.$apply(),console.log(d),setTimeout(function(){$(".ui-grid-footer-cell").addClass("center"),d.gridApi.core.queueRefresh(),d.gridApi.core.queueGridRefresh()},500)},500)),console.log(a)})})}else f.go("login")}]);